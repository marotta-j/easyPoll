{% extends 'base.html' %}
{% block title %} Home Page {% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center mb-4">Create a Poll</h1>

    <!-- Poll creation form -->
    <form id="createPollForm">
      <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
          <div class="form-group">
            <label for="pollQuestion" class="form-label">Poll Question</label>
            <input type="text" id="pollQuestion" name="question" class="form-control" placeholder="Enter the poll question" required>
          </div>
        </div>
      </div>

      <!-- Dynamic answer options -->
      <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
          <div class="form-group" id="answerOptions">
            <label class="form-label">Answer Options</label>
            <div class="answer-option d-flex mb-2">
              <input type="text" name="answer_option" class="form-control me-2" placeholder="Enter answer option" required>
            </div>
            <div class="answer-option d-flex mb-2">
              <input type="text" name="answer_option" class="form-control me-2" placeholder="Enter answer option" required>
            </div>
          </div>
        </div>
      </div>

      <!-- Button to add more options -->
      <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
          <button type="button" id="addOptionBtn" class="btn btn-outline-primary w-100">Add Another Option</button>
        </div>
      </div>

      <!-- Submit button -->
      <div class="row mb-4">
        <div class="col-md-8 offset-md-2 text-center">
          <button type="submit" class="btn btn-primary w-100 submit-btn">Create Poll</button>
        </div>
      </div>
    </form>
</div>

<script>
  // Get the CSRF token from the template
  const csrfToken = '{{ csrf_token }}';

  // Add a new answer option field
  document.getElementById("addOptionBtn").addEventListener("click", function() {
    const newOption = document.createElement("div");
    newOption.classList.add("answer-option", "d-flex", "mb-2");
    newOption.innerHTML = `
      <input type="text" name="answer_option" class="form-control me-2" placeholder="Enter answer option" required>
      <button type="button" class="btn btn-outline-danger remove-option">Remove</button>
    `;
    document.getElementById("answerOptions").appendChild(newOption);
  });

  // Remove an answer option
  document.getElementById("answerOptions").addEventListener("click", function(e) {
    if (e.target && e.target.classList.contains("remove-option")) {
      e.target.parentElement.remove();
    }
  });

  // Handle form submission
  document.getElementById("createPollForm").addEventListener("submit", function(e) {
    e.preventDefault();

    // Collect form data
    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
      if (!data[key]) {
        data[key] = [];
      }
      data[key].push(value);
    });

    // Send data to backend (AJAX)
    $.ajax({
      type: "POST",
      url: "/",  // Backend URL to handle poll creation
      data: JSON.stringify(data),
      contentType: "application/json",
      beforeSend: function(xhr) {
        // Add CSRF token to the request header
        xhr.setRequestHeader("X-CSRFToken", csrfToken);
      },
      success: function(response) {
        window.location.href = "/" + response;
      },
      error: function(xhr, status, error) {
        alert("Error: " + error);
      }
    });
  });
</script>
{% endblock %}
